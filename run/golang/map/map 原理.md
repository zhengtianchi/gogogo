# map åŸç†



## é¢è¯•é¢˜ï¼š

mapæ€ä¹ˆå®ç°ï¼Œåº•å±‚æ˜¯ä»€ä¹ˆï¼ˆæ•°ç»„ï¼‰ï¼Œå“ˆå¸Œè¡¨æ˜¯ä»€ä¹ˆï¼Œk-væ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå“ˆå¸Œå‡½æ•°çš„ä½œç”¨ï¼Œæ˜ å°„åˆ°æ•°ç»„ä¸Šï¼Œå“ˆå¸Œå†²çªæ€ä¹ˆå®ç°ï¼Œé“¾è¡¨æ³•é‡Œé¢æ˜¯ä»€ä¹ˆ



ä»Šå¤©è¦åˆ†äº«çš„æ˜¯ä¸»è¦å†…å®¹æ˜¯`Goè¯­è¨€Mapåº•å±‚å®ç°`ï¼Œç›®çš„è®©å¤§å®¶å¿«é€Ÿäº†è§£`Goè¯­è¨€Map`åº•å±‚å¤§è‡´çš„å®ç°åŸç†ã€‚è¯»å®Œæœ¬ç¯‡æ–‡ç« ä½ å¯ä»¥è·å¾—æ”¶ç›Šã€ä»¥åŠæˆ‘æ‰€æœŸæœ›ä½ èƒ½è·å–çš„æ”¶ç›Šå¦‚ä¸‹ï¼š

| æ”¶ç›Šåºå· | æ”¶ç›Šæè¿°                              | æŒæ¡ç¨‹åº¦ |
| -------- | ------------------------------------- | -------- |
| æ”¶ç›Š1    | **å¤§è‡´**å¯¹Goè¯­è¨€Mapåº•å±‚å®ç°æœ‰ä¸€ä¸ªäº†è§£ | å¿…é¡»æŒæ¡ |
| æ”¶ç›Š2    | **å¤§è‡´çŸ¥é“**Goè¯­è¨€Mapæ˜¯å¦‚ä½•è¯»å–æ•°æ®çš„ | å¿…é¡»æŒæ¡ |
| æ”¶ç›Š3    | **ç†Ÿæ‚‰**Goè¯­è¨€Mapåº•å±‚æ ¸å¿ƒç»“æ„ä½“`hmap` | å¯é€‰     |
| æ”¶ç›Š4    | **ç†Ÿæ‚‰**Goè¯­è¨€Mapåº•å±‚æ ¸å¿ƒç»“æ„ä½“`bmap` | å¯é€‰     |
| æ”¶ç›Š5    | **ç†Ÿæ‚‰**Goè¯­è¨€Mapåº•å±‚é‡Œçš„æº¢å‡ºæ¡¶       | å¯é€‰     |
| æ”¶ç›Š6    | **ç†Ÿæ‚‰**Goè¯­è¨€Mapæ˜¯å¦‚ä½•è¯»å–æ•°æ®çš„     | å¯é€‰     |

æ”¶ç›Š1å’Œæ”¶ç›Š2æ˜¯çœ‹äº†æœ¬ç¯‡æ–‡ç« å¸Œæœ›å¤§å®¶**å¿…é¡»æŒæ¡**çš„çŸ¥è¯†ç‚¹ï¼Œå…¶ä»–çš„ä¸ºå¯é€‰é¡¹ï¼Œå¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£æˆ–è€…å·²ç»æŒæ¡äº†æ”¶ç›Š1ã€2å¯ä»¥ç»§ç»­é˜…è¯»æ­¤å¤„çš„å†…å®¹ã€‚

å¯¹äºæœ¬ç¯‡æ–‡ç« çš„ç»“æ„ä¸»è¦æŒ‰å¦‚ä¸‹é¡ºåºå¼€å±•ï¼š

- ç®€å•çœ‹çœ‹ä¸€èˆ¬Mapçš„å®ç°æ€è·¯
- Goè¯­è¨€é‡ŒMapçš„å®ç°æ€è·¯(å…¥é—¨ç¨‹åº¦ï¼šåŒ…å«æ”¶ç›Š1ã€2)
- Goè¯­è¨€é‡ŒMapçš„å®ç°æ€è·¯(ç†Ÿæ‚‰ç¨‹åº¦ï¼šåŒ…å«æ”¶ç›Š3ã€4ã€5ã€6)

å…¶æ¬¡ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦ä»¥**Mapçš„è¯»**æ¥å±•å¼€åˆ†æï¼Œå› ä¸ºè¯»å¼„æ˜ç™½äº†ï¼Œå…¶ä»–çš„å†™ã€æ›´æ–°ã€åˆ é™¤ç­‰åŸºæœ¬æ“ä½œåŸºæœ¬éƒ½å¯ä»¥çŒœå‡ºæ¥äº†ï¼Œä¸æ˜¯ä¹ˆğŸ˜ã€‚

## **ç®€å•çœ‹çœ‹ä¸€èˆ¬Mapçš„å®ç°æ€è·¯**

ç›´å…¥ä¸»é¢˜ï¼Œä¸€èˆ¬çš„Mapä¼šåŒ…å«ä¸¤ä¸ªä¸»è¦ç»“æ„ï¼š

- æ•°ç»„ï¼šæ•°ç»„é‡Œçš„å€¼æŒ‡å‘ä¸€ä¸ªé“¾è¡¨
- é“¾è¡¨ï¼šç›®çš„è§£å†³hashå†²çªçš„é—®é¢˜ï¼Œå¹¶å­˜æ”¾é”®å€¼

å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š

![å›¾ç‰‡](img/640.png)

è¯»å–ä¸€ä¸ªkeyå€¼çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

```
                  key
                   |
                   v                 
+------------------------------------+
|      keyé€šè¿‡hashå‡½æ•°å¾—åˆ°keyçš„hash    |
+------------------+-----------------+
                   |
                   v
+------------------------------------+
|       keyçš„hashé€šè¿‡å–æ¨¡æˆ–è€…ä½æ“ä½œ     |
|          å¾—åˆ°keyåœ¨æ•°ç»„ä¸Šçš„ç´¢å¼•        |
+------------------------------------+
                   |
                   v
+------------------------------------+
|         é€šè¿‡ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„é“¾è¡¨         |
+------------------+-----------------+
                   |
                   v
+------------------------------------+
|       éå†é“¾è¡¨å¯¹æ¯”keyå’Œç›®æ ‡key        |
+------------------+-----------------+
                   |
                   v
+------------------------------------+
|              ç›¸ç­‰åˆ™è¿”å›value         |
+------------------+-----------------+
                   |
                   v                
                 value
```

æ¥ç€æˆ‘ä»¬æ¥ç®€å•çœ‹çœ‹Goè¯­è¨€é‡ŒMapçš„å®ç°æ€è·¯ã€‚

## **Goè¯­è¨€é‡ŒMapçš„å®ç°æ€è·¯(å…¥é—¨ç¨‹åº¦)**

> åŒ…å«æ”¶ç›Š1ã€2

Goè¯­è¨€è§£å†³hashå†²çªä¸æ˜¯é“¾è¡¨ï¼Œå®é™…**ä¸»è¦**ç”¨çš„æ•°ç»„(å†…å­˜ä¸Šçš„è¿ç»­ç©ºé—´)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```
å¤‡æ³¨ï¼šåé¢æˆ‘ä»¬ä¼šè§£é‡Šä¸Šé¢ä¸ºå•¥ç”¨çš„â€œä¸»è¦â€ä¸¤ä¸ªå­—ã€‚
```

![å›¾ç‰‡](img/640-20221222212408340.png)

ä½†æ˜¯å¹¶ä¸æ˜¯åªä½¿ç”¨ä¸€ä¸ªæ•°ç»„(è¿ç»­å†…å­˜ç©ºé—´)å­˜æ”¾é”®å’Œå€¼ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨é”®å’Œå€¼ï¼Œå›¾ç¤ºå¦‚ä¸‹ï¼š

![å›¾ç‰‡](img/640-20221222212412349.png)

ä¸Šå›¾ä¸­ï¼š

- åˆ†åˆ«å¯¹åº”çš„æ˜¯ä¸¤ä¸ªæ ¸å¿ƒçš„ç»“æ„ä½“`hmap`å’Œ`bmap`
- `bmap`é‡Œæœ‰ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜æ”¾keyå’Œvalue

æŠŠä¸Šé¢ç®€åŒ–çš„å…³ç³»è½¬æ¢ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå¤§è‡´å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](img/640-20221222212416580.png)

æˆ‘ä»¬é€šè¿‡ä¸€æ¬¡`è¯»æ“ä½œ`ä¸ºä¾‹ï¼Œçœ‹çœ‹è¯»å–æŸä¸ªkeyçš„å€¼çš„ä¸€ä¸ª**å¤§è‡´è¿‡ç¨‹**ï¼š

| æ­¥éª¤ç¼–å· | æè¿°                                                         |
| :------- | :----------------------------------------------------------- |
| â‘         | é€šè¿‡hashå‡½æ•°è·å–ç›®æ ‡keyçš„**å“ˆå¸Œ**ï¼Œå“ˆå¸Œå’Œæ•°ç»„çš„é•¿åº¦é€šè¿‡ä½æ“ä½œè·å–æ•°ç»„ä½ç½®çš„**ç´¢å¼•**(å¤‡æ³¨ï¼šè·å–ç´¢å¼•å€¼çš„æ–¹å¼ä¸€èˆ¬æœ‰å–æ¨¡æˆ–ä½æ“ä½œï¼Œä½æ“ä½œçš„æ€§èƒ½å¥½äº›) |
| â‘¡        | éå†bmapé‡Œçš„é”®ï¼Œå’Œç›®æ ‡keyå¯¹æ¯”è·å–**keyçš„ç´¢å¼•**(æ‰¾ä¸åˆ°åˆ™è¿”å›ç©ºå€¼) |
| â‘¢        | æ ¹æ®**keyçš„ç´¢å¼•**é€šè¿‡è®¡ç®—åç§»é‡ï¼Œè·å–åˆ°å¯¹åº”**value**         |

è¯»è¿‡ç¨‹å›¾ç¤ºå¦‚ä¸‹ï¼š

![å›¾ç‰‡](img/640-20221222212420931.png)

è¿™ä¹ˆçœ‹èµ·æ¥æ˜¯ä¸æ˜¯â€œå¾ˆç®€å•â€ã€å¾ˆæ¸…æ™°ï¼Œæ‰€ä»¥è¯»åˆ°è¿™é‡Œï¼Œä½ æ˜¯ä¸æ˜¯å·²ç»å…¥é—¨äº†`Goè¯­è¨€Mapåº•å±‚å®ç°`å¹¶ä¸”ï¼š

- **å¤§è‡´**å¯¹Goè¯­è¨€Mapåº•å±‚å®ç°æœ‰ä¸€ä¸ªäº†è§£(æ”¶ç›Š1)
- **å¤§è‡´çŸ¥é“**Goè¯­è¨€Mapæ˜¯å¦‚ä½•è¯»å–æ•°æ®çš„(æ”¶ç›Š2)

ç„¶è€Œå®é™…æƒ…å†µä¸æ­¢å¦‚æ­¤ï¼Œæˆ‘ä»¬å†ç¨å¾®æ·±å…¥çš„æ¢ç´¢ä¸‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ï¼Œæ²¡å…´è¶£å¯ä»¥ä¸ç”¨ç»§ç»­å¾€ä¸‹çœ‹äº†(å¼€ç©ç¬‘=^_^=)ï¼Œåæ­£å·²ç»è¾¾åˆ°ç›®çš„äº†ï¼Œå“ˆå“ˆğŸ˜ã€‚

## **Goè¯­è¨€é‡ŒMapçš„å®ç°æ€è·¯(ç†Ÿæ‚‰ç¨‹åº¦)**

> åŒ…å«æ”¶ç›Š3ã€4ã€5ã€6

æƒ³è¦æ·±å…¥å­¦ä¹ ï¼Œé¦–å…ˆå¾—äº†è§£ä¸‹ä¸Šé¢æåˆ°äº†å®ç°Mapçš„ä¸¤ä¸ªæ ¸å¿ƒç»“æ„ä½“`hmap`å’Œ`bmap`ã€‚

### **æ ¸å¿ƒç»“æ„ä½“`hmap`**

```
æ”¶ç›Š3: ç†Ÿæ‚‰Goè¯­è¨€Mapåº•å±‚æ ¸å¿ƒç»“æ„ä½“`hmap`
```

`hmap`çš„ç»“æ„å…¶å®åˆšå¼€å§‹çœ‹èµ·æ¥å…¶å®è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæœ‰ä¸å°‘çš„å­—æ®µï¼Œå…·ä½“å­—æ®µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](img/640-20221222212425570.png)

å­—æ®µé‡Šä¹‰å¦‚ä¸‹ï¼š

| å­—æ®µ       | è§£é‡Š                                                         |
| :--------- | :----------------------------------------------------------- |
| count      | é”®å€¼å¯¹çš„æ•°é‡                                                 |
| B          | 2^B=len(buckets)                                             |
| hash0      | hashå› å­                                                     |
| buckets    | æŒ‡å‘ä¸€ä¸ªæ•°ç»„(è¿ç»­å†…å­˜ç©ºé—´)ï¼Œæ•°ç»„çš„ç±»å‹ä¸º[]bmapï¼Œbmapç±»å‹å°±æ˜¯å­˜åœ¨é”®å€¼å¯¹çš„ç»“æ„ä¸‹é¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™ä¸ªå­—æ®µæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºæ­£å¸¸æ¡¶ã€‚**å¦‚ä¸‹å›¾æ‰€ç¤º** |
| oldbuckets | æ‰©å®¹æ—¶ï¼Œå­˜æ”¾ä¹‹å‰çš„buckets(Mapæ‰©å®¹ç›¸å…³å­—æ®µ)                   |
| extra      | æº¢å‡ºæ¡¶ç»“æ„ï¼Œæ­£å¸¸æ¡¶é‡Œé¢æŸä¸ªbmapå­˜æ»¡äº†ï¼Œä¼šä½¿ç”¨è¿™é‡Œé¢çš„å†…å­˜ç©ºé—´å­˜æ”¾é”®å€¼å¯¹ |
| noverflow  | æº¢å‡ºæ¡¶é‡Œbmapå¤§è‡´çš„æ•°é‡                                       |
| nevacuate  | åˆ†æµæ¬¡æ•°ï¼Œæˆå€æ‰©å®¹åˆ†æµæ“ä½œè®¡æ•°çš„å­—æ®µ(Mapæ‰©å®¹ç›¸å…³å­—æ®µ)        |
| flags      | çŠ¶æ€æ ‡è¯†ï¼Œæ¯”å¦‚æ­£åœ¨è¢«å†™ã€bucketså’Œoldbucketsåœ¨è¢«éå†ã€ç­‰é‡æ‰©å®¹(Mapæ‰©å®¹ç›¸å…³å­—æ®µ) |

```
å¤‡æ³¨ï¼šæœ¬æ¬¡å†…å®¹ä¸æ¶‰åŠMapçš„æ‰©å®¹é€»è¾‘ã€‚
```

é‡ç‚¹çœ‹ä¸€äº›å­—æ®µçš„å«ä¹‰å’Œç”¨å¤„ã€‚

#### å­—æ®µ`buckets`

![å›¾ç‰‡](img/640-20221222212431804.png)

`buckets`æŒ‡å‘äº†ä¸€ä¸ªæ•°ç»„(è¿ç»­çš„å†…å­˜ç©ºé—´)ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯`bmap`ç±»å‹ï¼Œè¿™ä¸ªå­—æ®µæˆ‘ä»¬ç§°ä¹‹ä¸ºæ­£å¸¸æ¡¶ã€‚

hmapçš„æºç å’Œåœ°å€å¦‚ä¸‹ï¼š

```go
//https://github.com/golang/go/blob/go1.13.8/src/runtime/map.go
type hmap struct {
	count     int 
	flags     uint8
	B         uint8 
	noverflow uint16 
	hash0     uint32
	buckets    unsafe.Pointer
	oldbuckets unsafe.Pointer
	nevacuate  uintptr 
	extra *mapextra
}
```

### **æ ¸å¿ƒç»“æ„ä½“`bmap`**

```
æ”¶ç›Š4: Goè¯­è¨€Mapåº•å±‚æ ¸å¿ƒç»“æ„ä½“`bmap`
```

æ­£å¸¸æ¡¶`hmap.buckets`çš„å…ƒç´ æ˜¯ä¸€ä¸ª`bmap`ç»“æ„ã€‚`bmap`çš„å…·ä½“å­—æ®µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](img/640-20221222212436810.png)

å­—æ®µé‡Šä¹‰å¦‚ä¸‹ï¼š

| å­—æ®µ     | è§£é‡Š                                                         |
| :------- | :----------------------------------------------------------- |
| topbits  | é•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œ[]uint8ï¼Œå…ƒç´ ä¸ºï¼škeyè·å–çš„hashçš„é«˜8ä½ï¼Œéå†æ—¶å¯¹æ¯”ä½¿ç”¨ï¼Œæé«˜æ€§èƒ½ã€‚**å¦‚ä¸‹å›¾æ‰€ç¤º** |
| keys     | é•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œ[]keytypeï¼Œå…ƒç´ ä¸ºï¼šå…·ä½“çš„keyå€¼ã€‚**å¦‚ä¸‹å›¾æ‰€ç¤º** |
| elems    | é•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œ[]elemtypeï¼Œå…ƒç´ ä¸ºï¼šé”®å€¼å¯¹çš„keyå¯¹åº”çš„å€¼ã€‚**å¦‚ä¸‹å›¾æ‰€ç¤º** |
| overflow | æŒ‡å‘çš„`hmap.extra.overflow`æº¢å‡ºæ¡¶é‡Œçš„`bmap`ï¼Œä¸Šé¢çš„å­—æ®µ`topbits`ã€`keys`ã€`elems`é•¿åº¦ä¸º8ï¼Œæœ€å¤šå­˜8ç»„é”®å€¼å¯¹ï¼Œå­˜æ»¡äº†å°±å¾€æŒ‡å‘çš„è¿™ä¸ª`bmap`é‡Œå­˜ |
| pad      | å¯¹é½å†…å­˜ä½¿ç”¨çš„ï¼Œä¸æ˜¯æ¯ä¸ªbmapéƒ½æœ‰ä¼šè¿™ä¸ªå­—æ®µï¼Œéœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶ |

![å›¾ç‰‡](img/640-20221222212509795.png)

æ¨æ–­å‡º`bmap`ç»“æ„å­—æ®µçš„ä»£ç å’Œä½ç½®å¦‚ä¸‹ï¼š

```go
//https://github.com/golang/go/blob/go1.13.8/src/cmd/compile/internal/gc/reflect.go
func bmap(t *types.Type) *types.Type {
  // ç•¥...

  field := make([]*types.Field, 0, 5)

	field = append(field, makefield("topbits", arr))

  // ç•¥...
  
	keys := makefield("keys", arr)
	field = append(field, keys)

  // ç•¥...
  
	elems := makefield("elems", arr)
	field = append(field, elems)

  // ç•¥...
  
	if int(elemtype.Align) > Widthptr || int(keytype.Align) > Widthptr {
		field = append(field, makefield("pad", types.Types[TUINTPTR]))
	}

  // ç•¥...
  
	overflow := makefield("overflow", otyp)
	field = append(field, overflow)

  // ç•¥...
}
```

> ç»“è®ºï¼šæ¯ä¸ª`bmap`ç»“æ„æœ€å¤šå­˜æ”¾8ç»„é”®å€¼å¯¹ã€‚

### **`hmap`å’Œ`bmap`çš„åŸºæœ¬ç»“æ„åˆèµ·æ¥**

åˆ†åˆ«äº†è§£äº†`hmap`å’Œ`bmap`çš„åŸºæœ¬ç»“æ„åï¼Œæˆ‘ä»¬æŠŠä¸Šé¢çš„å†…å®¹åˆå¹¶èµ·æ¥ï¼Œå°±å¾—åˆ°å¦‚ä¸‹çš„Mapç»“æ„å›¾ï¼š

![å›¾ç‰‡](img/640-20221222212528737.png)

### **æº¢å‡ºæ¡¶**

```
æ”¶ç›Š5: ç†Ÿæ‚‰Goè¯­è¨€Mapåº•å±‚é‡Œçš„æº¢å‡ºæ¡¶
```

ä¸Šé¢è®²`bmap`çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æ˜¯å¾—åˆ°äº†ä¸ªç»“è®ºä¹ˆâ€œæ¯ä¸ª`bmap`ç»“æ„æœ€å¤šå­˜æ”¾8ç»„é”®å€¼å¯¹ã€‚â€ï¼Œæ‰€ä»¥é—®é¢˜æ¥äº†ï¼š

> æ­£å¸¸æ¡¶é‡Œçš„`bmap`å­˜æ»¡äº†æ€ä¹ˆåŠ?

è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å°±è¦è¯´åˆ°`hmap.extra`ç»“æ„äº†ï¼Œ`hmap.extra`æ˜¯ä¸ªç»“æ„ä½“ï¼Œç»“æ„å›¾ç¤ºå’Œå­—æ®µé‡Šä¹‰å¦‚ä¸‹ï¼š

![å›¾ç‰‡](img/640-20221222212533122.png)

| å­—æ®µ         | è§£é‡Š                                                         |
| :----------- | :----------------------------------------------------------- |
| overflow     | ç§°ä¹‹ä¸º**æº¢å‡ºæ¡¶**ã€‚å’Œ`hmap.buckets`çš„ç±»å‹ä¸€æ ·ä¹Ÿæ˜¯æ•°ç»„`[]bmap`ï¼Œå½“æ­£å¸¸æ¡¶`bmap`å­˜æ»¡äº†çš„æ—¶å€™å°±ä½¿ç”¨`hmap.extra.overflow`çš„`bmap`ã€‚æ‰€ä»¥è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ­£å¸¸æ¡¶`hmap.buckets`é‡Œçš„`bmap`æ˜¯æ€ä¹ˆå…³è”ä¸Šæº¢å‡ºæ¡¶`hmap.extra.overflow`çš„`bmap`å‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢è¯´ã€‚ |
| oldoverflow  | æ‰©å®¹æ—¶å­˜æ”¾ä¹‹å‰çš„overflow(Mapæ‰©å®¹ç›¸å…³å­—æ®µ)                    |
| nextoverflow | æŒ‡å‘æº¢å‡ºæ¡¶é‡Œä¸‹ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„`bmap`                           |

æºç å’Œåœ°å€å¦‚ä¸‹ï¼š

```go
//https://github.com/golang/go/blob/go1.13.8/src/runtime/map.go
type mapextra struct {
	overflow    *[]*bmap
	oldoverflow *[]*bmap
	nextOverflow *bmap
}
```

> é—®é¢˜ï¼šæ­£å¸¸æ¡¶`hmap.buckets`é‡Œçš„`bmap`æ˜¯æ€ä¹ˆå…³è”ä¸Šæº¢å‡ºæ¡¶`hmap.extra.overflow`çš„`bmap`å‘¢ï¼Ÿ

ç­”ï¼šå°±æ˜¯æˆ‘ä»¬ä»‹ç»`bmap`ç»“æ„æ—¶é‡Œçš„`bmap.overflow`å­—æ®µ(å¦‚ä¸‹å›¾æ‰€ç¤º)ã€‚`bmap.overflow`æ˜¯ä¸ªæŒ‡é’ˆç±»å‹ï¼Œå­˜æ”¾äº†å¯¹åº”ä½¿ç”¨çš„æº¢å‡ºæ¡¶`hmap.extra.overflow`é‡Œçš„`bmap`çš„åœ°å€ã€‚

![å›¾ç‰‡](img/640-20221222212544464.png)

é—®é¢˜åˆæ¥äº†ï¼š

> é—®é¢˜ï¼šæ­£å¸¸æ¡¶`hmap.buckets`é‡Œçš„`bmap`æ˜¯ä»€ä¹ˆæ—¶å€™å…³è”ä¸Šæº¢å‡ºæ¡¶`hmap.extra.overflow`çš„`bmap`å‘¢ï¼Ÿ

ç­”ï¼šMapå†™æ“ä½œçš„æ—¶å€™ã€‚è¿™é‡Œç›´æ¥çœ‹å…³é”®ä»£ç ï¼š

```go
// https://github.com/golang/go/blob/go1.13.8/src/runtime/map.go
func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer {
  // ç•¥
again:
	// ç•¥...
	var inserti *uint8
  // ç•¥...
bucketloop:
	for {
		for i := uintptr(0); i < bucketCnt; i++ {
      // keyçš„hashé«˜8ä½ä¸ç›¸ç­‰
			if b.tophash[i] != top {
        // å½“å‰ä½ç½®bmap.tophashçš„å…ƒç´ ä¸ºç©ºä¸”è¿˜æ²¡æœ‰å†™å…¥çš„è®°å½•(insertiå·²ç»å†™å…¥çš„æ ‡è®°ä¸º)
				if isEmpty(b.tophash[i]) && inserti == nil {
          // insertièµ‹å€¼ä¸ºå½“å‰çš„hashé«˜8ä½ æ ‡è®°å†™å…¥æˆåŠŸ
					inserti = &b.tophash[i]
					// ç•¥...
				}
				// ç•¥...
				continue
			}
			// ç•¥...
			goto done
    }
    // æ­£å¸¸æ¡¶çš„bmapéå†å®Œäº† ç»§ç»­éå†æº¢å‡ºæ¡¶çš„bmap å¦‚æœæœ‰çš„è¯
		ovf := b.overflow(t)
		if ovf == nil {
			break
    }
		b = ovf
	}

  // ç•¥...

  // æ²¡å†™å…¥æˆåŠŸ(åŒ…å«æ­£å¸¸æ¡¶çš„bmapã€æº¢å‡ºæ¡¶çš„bmap(å¦‚æœæœ‰çš„è¯))
	if inserti == nil {
    // åˆ†é…æ–°çš„bmapå†™
    newb := h.newoverflow(t, b)
    // ç•¥...
	}

	// ç•¥...
}

// ç»§ç»­çœ‹h.newoverflowçš„ä»£ç 
func (h *hmap) newoverflow(t *maptype, b *bmap) *bmap {
  var ovf *bmap
  // å¦‚æœhmapçš„å­˜åœ¨æº¢å‡ºæ¡¶ ä¸” æº¢å‡ºæ¡¶è¿˜æ²¡ç”¨å®Œ
	if h.extra != nil && h.extra.nextOverflow != nil {
    // ä½¿ç”¨æº¢å‡ºæ¡¶çš„bmap
    ovf = h.extra.nextOverflow
    // åˆ¤æ–­æ¡¶çš„bmapçš„overflowæ˜¯ä¸æ˜¯ç©º
    // è¿™é‡Œå¾ˆå·§å¦™ã€‚ä¸ºå•¥ï¼Ÿ
    // æº¢å‡ºæ¡¶åˆå§‹åŒ–çš„æ—¶å€™ä¼šæŠŠæœ€åä¸€ä¸ªbmapçš„overflowæŒ‡å‘æ­£å¸¸æ¡¶ï¼Œå€¼ä¸ä¸ºnil
    // ç›®çš„åˆ¤æ–­å½“å‰è¿™ä¸ªbmapæ˜¯ä¸æ˜¯æº¢å‡ºæ¡¶é‡Œçš„æœ€åä¸€ä¸ª
		if ovf.overflow(t) == nil {
      // æ˜¯nil
      // è¯´æ˜ä¸æ˜¯æœ€åä¸€ä¸ª
			h.extra.nextOverflow = (*bmap)(add(unsafe.Pointer(ovf), uintptr(t.bucketsize)))
		} else {
      // ä¸æ˜¯nil
      // åˆ™é‡ç½®å½“å‰bmapçš„overflowä¸ºç©º
      ovf.setoverflow(t, nil)
      // ä¸” æ ‡è®°nextOverflowä¸ºnil è¯´æ˜å½“å‰æº¢å‡ºæ¡¶ç”¨å®Œäº†
			h.extra.nextOverflow = nil
		}
	} else {
    // æ²¡æœ‰æº¢å‡ºæ¡¶ æˆ–è€… æº¢å‡ºæ¡¶ç”¨å®Œäº†
    // å†…å­˜ç©ºé—´é‡æ–°åˆ†é…ä¸€ä¸ªbmap
		ovf = (*bmap)(newobject(t.bucket))
  }
  // ç”Ÿæˆæº¢å‡ºæ¡¶bmapçš„è®¡æ•°å™¨è®¡æ•°
	h.incrnoverflow()
  // ç•¥...
  // è¿™è¡Œä»£ç å°±æ˜¯ä¸Šé¢é—®é¢˜æˆ‘ä»¬è¦çš„ç­”æ¡ˆ:
  // æ­£å¸¸æ¡¶`hmap.buckets`é‡Œçš„`bmap`åœ¨è¿™é‡Œå…³è”ä¸Šæº¢å‡ºæ¡¶`hmap.extra.overflow`çš„`bmap`
	b.setoverflow(t, ovf)
	return ovf
}

// setoverflowå‡½æ•°çš„æºç 
func (b *bmap) setoverflow(t *maptype, ovf *bmap) {
  // è¿™è¡Œä»£ç çš„æ„æ€ï¼šé€šè¿‡åç§»é‡è®¡ç®—æ‰¾åˆ°äº†bmap.overflowï¼Œå¹¶æŠŠovfè¿™ä¸ªbmapçš„åœ°å€èµ‹å€¼ç»™äº†bmap.overflow
	*(**bmap)(add(unsafe.Pointer(b), uintptr(t.bucketsize)-sys.PtrSize)) = ovf
}
```

ä¸‹é¢ä»£ç è¿™æ®µä»£ç è§£é‡Šäº†ï¼Œä¸Šé¢çš„æºç ä¸­ä¸ºä½•å¦‚æ­¤åˆ¤æ–­é¢„åˆ†é…æº¢å‡ºæ¡¶çš„`bmap`æ˜¯æœ€åä¸€ä¸ªçš„åŸå› ã€‚

```go
// https://github.com/golang/go/blob/go1.13.8/src/runtime/map.go
// åˆ›å»ºhmapçš„æ­£å¸¸æ¡¶
func makeBucketArray(t *maptype, b uint8, dirtyalloc unsafe.Pointer) (buckets unsafe.Pointer, nextOverflow *bmap) {
  // ç•¥...
	if base != nbuckets {
    // ç•¥...
    last := (*bmap)(add(buckets, (nbuckets-1)*uintptr(t.bucketsize)))
    // æŠŠæº¢å‡ºæ¡¶é‡Œ æœ€åä¸€ä¸ª `bmap`çš„`overflow`æŒ‡å…ˆæ­£å¸¸æ¡¶çš„ç¬¬ä¸€ä¸ª`bmap`
    // è·å–é¢„åˆ†é…çš„æº¢å‡ºæ¡¶é‡Œ`bmap`æ—¶ï¼Œå¯ä»¥é€šè¿‡åˆ¤æ–­overflowæ˜¯ä¸æ˜¯ä¸ºnilåˆ¤æ–­æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ª
		last.setoverflow(t, (*bmap)(buckets))
  }
  // ç•¥...
}
```

**å½“hmapå­˜åœ¨æº¢å‡ºæ¡¶æ—¶**ï¼Œä¸”**å½“å‰æº¢å‡ºæ¡¶åªè¢«ä½¿ç”¨äº†ä¸€ä¸ªbmapæ—¶**ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„å…³ç³»å›¾ï¼š

![å›¾ç‰‡](img/640-20221222212620790.png)

åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ­£å¸¸æ¡¶çš„`bmap`å’Œæº¢å‡ºæ¡¶çš„`bmap`å®é™…æ„æˆäº†é“¾è¡¨å…³ç³»ï¼Œæ‰€ä»¥è¿™ä¹Ÿè§£é‡Šäº†å¼€ç¯‡æˆ‘ä»¬è¯´åˆ°çš„â€œ**Goé‡Œé¢Mapçš„å®ç°ä¸»è¦ç”¨åˆ°äº†æ•°ç»„**â€ï¼Œå…¶æ¬¡è¿˜ç”¨åˆ°äº†é“¾è¡¨ã€‚

### **å†æ¬¡åˆ†æMapçš„è¯»**

```
æ”¶ç›Š6: ç†Ÿæ‚‰Goè¯­è¨€Mapæ˜¯å¦‚ä½•è¯»å–æ•°æ®çš„
```

é€šè¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å†æ¬¡é€šè¿‡ä¸€æ¬¡è¯»æ“ä½œä¸ºä¾‹ï¼Œçœ‹çœ‹è¯»å–æŸä¸ªkeyçš„å€¼çš„ä¸€ä¸ªå¤§è‡´è¿‡ç¨‹ï¼š

![å›¾ç‰‡](img/640-20221222212627085.png)

ç»“åˆä»£ç åˆ†æä¸‹æ•´ä¸ªå¤§ä½“çš„è¿‡ç¨‹ï¼š

```go
func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer {
    // ...ç•¥
    
    // â‘ é€šè¿‡hashå‡½æ•°è·å–å½“å‰keyçš„å“ˆå¸Œ
	hash := alg.hash(key, uintptr(h.hash0))
    m := bucketMask(h.B)
    // â‘¡é€šè¿‡å½“å‰keyçš„å“ˆå¸Œè·å–åˆ°å¯¹åº”çš„bmapç»“æ„çš„b
    // è¿™é‡Œçš„b æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ­£å¸¸æ¡¶çš„bmapâ€
    // â€œæ­£å¸¸æ¡¶çš„bmapâ€å¯èƒ½ä¼šå¯¹åº”åˆ°æº¢å‡ºæ¡¶çš„bmapç»“æ„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæº¢å‡ºæ¡¶çš„bmapâ€
    b := (*bmap)(add(h.buckets, (hash&m)*uintptr(t.bucketsize)))
    
    // ...ç•¥
    
    // è·å–å½“å‰keyçš„å“ˆå¸Œçš„é«˜8ä½
	top := tophash(hash)
bucketloop:
    // ä¸‹é¢çš„forå¾ªç¯æ˜¯ä¸ªç®€å†™ï¼Œå®Œæ•´å¦‚ä¸‹ã€‚
    // for b = b; b != nil; b = b.overflow(t) {
    // å¯ä»¥çŸ¥é“bçš„åˆå§‹å€¼ä¸ºä¸Šé¢çš„â€œæ­£å¸¸æ¡¶çš„bmapâ€ï¼Œåˆ™ï¼š
    // ç¬¬ä¸€æ¬¡éå†ï¼šéå†çš„æ˜¯â€œæ­£å¸¸æ¡¶çš„bmapâ€
    // å¦‚æœæ­£å¸¸æ¡¶æ²¡æ‰¾åˆ°ï¼Œåˆ™
    // ç»¿è‰²çº¿æ¡â‘£ ç»§ç»­éå†ï¼šå¦‚æœå½“å‰â€œæ­£å¸¸æ¡¶çš„bmapâ€ä¸­çš„overflowå€¼ä¸ä¸ºnil(è¯´æ˜â€œæ­£å¸¸æ¡¶çš„bmapâ€å…³è”äº†â€œæº¢å‡ºæ¡¶çš„bmapâ€)ï¼Œåˆ™éå†å½“å‰æŒ‡å‘çš„â€œæº¢å‡ºæ¡¶çš„bmapâ€ç»§ç»­ é‡å¤è“è‰²çº¿æ¡çš„â‘¢â‘£â‘¤æ­¥éª¤
	for ; b != nil; b = b.overflow(t) {
        // ç”±äºbçš„åˆå§‹å€¼ä¸ºâ€œæ­£å¸¸æ¡¶çš„bmapâ€ï¼Œç¬¬ä¸€æ¬¡å…ˆéå†â€œæ­£å¸¸æ¡¶çš„bmapâ€
		for i := uintptr(0); i < bucketCnt; i++ {
            // è“è‰²çº¿æ¡â‘¢ å¯¹æ¯”keyå“ˆå¸Œçš„é«˜8ä½
            // å¯¹æ¯”å“ˆå¸Œçš„é«˜8ä½ç›®çš„æ˜¯ä¸ºäº†åŠ é€Ÿ
			if b.tophash[i] != top {
                // emptyRest æ ‡å¿—ä½ï¼šè¡¨ç¤ºå½“å‰ä½ç½®å·²ç»æ˜¯æœ«å°¾äº†ï¼›åˆ é™¤æ“ä½œä¼šè®¾ç½®æ­¤æ ‡å¿—ä½
				if b.tophash[i] == emptyRest {
					break bucketloop
				}
				continue
            }
            // æ‰¾åˆ°äº†ç›¸åŒçš„hashé«˜8ä½ï¼Œåˆ™ï¼šæ‰¾åˆ°å¯¹åº”ç´¢å¼•ä½ç½®içš„key
			k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize))
			if t.indirectkey() {
				k = *((*unsafe.Pointer)(k))
            }
            // è“è‰²çº¿æ¡â‘£ å¯¹æ¯”keyæ˜¯ä¸æ˜¯ä¸€è‡´
			if alg.equal(key, k) {
                // è“è‰²çº¿æ¡â‘¤ keyæ˜¯ä¸€è‡´ï¼Œåˆ™ï¼šè·å–å¯¹åº”ç´¢å¼•ä½ç½®çš„å€¼
				e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize))
				if t.indirectelem() {
					e = *((*unsafe.Pointer)(e))
                }
                // è¿”å›æ‰¾åˆ°çš„ç»“æœ
				return e
			}
		}
    }
    // æ­£å¸¸æ¡¶ã€æº¢å‡ºæ¡¶éƒ½æ²¡æ‰¾åˆ°åˆ™è¿”å› â€œç©ºå€¼â€
	return unsafe.Pointer(&zeroVal[0])
}
```



> å‚è€ƒï¼š
> 	1.ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-hashmap/
>
> 2. Goæºç ç‰ˆæœ¬1.13.8 https://github.com/golang/go/tree/go1.13.8/src

